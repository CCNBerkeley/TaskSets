<!doctype html>
<html>
  <head>
    <title>Aliens</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-categorize.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-start_new_season.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-categorize-alienzzz2.js"></script>
    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>
  </body>

  <script>

  /* TDs
  - read the novelty paper with the crops and planets -> similar?
  - add the other levels
  - randomize association betweenn seasons and TS
  - CHECK pseudo-randomize season order
  - CHECK randomize association between season-pic and reward amounts
  - CHECK better reward schedule (right now, contexts can be recognized just because of the amounts)
  - CHECK draw rewards from distribution
  - CHECK make sure background comes on before aliens
  - CHECK add counter
  - CHECK only 3 actions
  - CHECK record data
  - CHECK mouse instead of keys
  - CHECK instructions: use example trial in stead of hard-coded slides?
  - CHECK add for SubjectID, etc.
  - CHECK display only one alien at a time
  - CHECK permute response buttons each time
  */

    training_rewards = [6, 6, 6]
    season_rewards_ordered = [
      [2, 4, 7],
      [6, 9, 3],
      [10, 5, 8]
    ]

    TS_train = [
      {key_answer: 0, sad_alien: 0},
      // {key_answer: 1, sad_alien: 1},
      // {key_answer: 2, sad_alien: 2},
      // {key_answer: 0, sad_alien: 0},
      // {key_answer: 1, sad_alien: 1},
      // {key_answer: 2, sad_alien: 2}
    ]

    TS1 = [
      // {key_answer: 0, sad_alien: 2},
      // {key_answer: 1, sad_alien: 1},
      {key_answer: 2, sad_alien: 0},
      // {key_answer: 0, sad_alien: 2},
      // {key_answer: 1, sad_alien: 1},
      // {key_answer: 2, sad_alien: 0},
    ]

    TS2 = [
      // {key_answer: 0, sad_alien: 1},
      {key_answer: 1, sad_alien: 0},
      // {key_answer: 2, sad_alien: 2},
      // {key_answer: 0, sad_alien: 1},
      // {key_answer: 1, sad_alien: 0},
      // {key_answer: 2, sad_alien: 2},
    ]

    TS3 = [
      {key_answer: 0, sad_alien: 0},
      // {key_answer: 1, sad_alien: 2},
      // {key_answer: 2, sad_alien: 1},
      // {key_answer: 0, sad_alien: 0},
      // {key_answer: 1, sad_alien: 2},
      // {key_answer: 2, sad_alien: 1},
    ]

    TSs = [TS1, TS2, TS3]

    TS_rands = [
      [0, 1, 2],
      [1, 2, 0],
      [2, 0, 1]
    ]

    var TS_rand = TS_rands[Math.floor(Math.random() * TS_rands.length)];  // TD! Draw

    var alien_height = 240
    var alien_height_point_counter = 60
    var sad_lefts = [0, 280, 520]
    var sad_left = 260
    var reward_top = - 27
    var reward_left = sad_left + 15
    var button_height = 50
    var points = [0, 0, 0]

    bed_button =
      "<button id='bed-button'" +
        "class='jspsych-btn'>" +
        "<img src='img/bed.png' height=" + button_height + ">" +
      "</button>"
    umbrella_button =
      "<button id='umbrella-button'" +
        "class='jspsych-btn'>" +
        "<img src='img/umbrella.png' height=" + button_height + ">" +
      "</button>"
    plant_button =
      "<button id='plant-button'" +
        "class='jspsych-btn'>" +
        "<img src='img/plant.png' height=" + button_height + ">" +
      "</button>"
    var buttons = [bed_button, umbrella_button, plant_button]

    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex;

      // While there remain elements to shuffle...
      while (0 !== currentIndex) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }

      return array;
    }

    shuffled_buttons = shuffle(buttons)
    response_buttons =
      "<center><div class='response_buttons' style='position:relative; border: 100px solid transparent; z=10;'>" +
        shuffled_buttons[0] +
        shuffled_buttons[1] +
        shuffled_buttons[2] +
      "</div></center>"

    dblue_alien = "<img src='img/alien1.png' "
    lgreen_alien = "<img src='img/alien2.png' "
    dred_alien = "<img src='img/alien3.png' "
    purple_alien = "<img src='img/alien4.png' "
    lblue_alien = "<img src='img/alien5.png' "
    dgreen_alien = "<img src='img/alien6.png' "
    alien_array = [dred_alien, lblue_alien, dgreen_alien]
    shuffled_aliens = shuffle(alien_array)

    var aliens =
      "<center><div style='position:relative; z=10;'>" +
        shuffled_aliens[0] + "height=" + alien_height + ">" +
        shuffled_aliens[1] + "height=" + alien_height + ">" +
        shuffled_aliens[2] + "height=" + alien_height + ">" +
      "</div></center>"

    var speech = "<img src='img/speech.png' style='position:absolute; left:" + sad_left + "px;' height=120>"
    var exclamation_points = "<p style='color:red; position:absolute; left:" + reward_left + "px; top:" + reward_top + "px; font-size:46px;'> !!!!"
    var reward = "<p style='color:green; position:absolute; left:" + reward_left + "px; top:" + reward_top + "px; font-size:46px;'> +5"

    var sad_alien =
      "<center><div style='position:relative'>" +
        dgreen_alien + "height=" + alien_height + ">" +
        speech + exclamation_points +
      "</div></center>"

    var happy_alien =
      "<center><div style='position:relative;'>" +
        dgreen_alien + "height=" + alien_height + ">" +
        speech + reward +
      "</div></center>"

    var happy_aliens =
      "<center><div style='position:relative;'>" +
        shuffled_aliens[0] + "height=" + alien_height + ">" +
        shuffled_aliens[1] + "height=" + alien_height + ">" +
        shuffled_aliens[2] + "height=" + alien_height + ">" +
        "<img src='img/happy2.png' style='position:absolute; left:" + sad_lefts[0] + "px;' height=120>" +
        "<img src='img/happy2.png' style='position:absolute; left:" + sad_lefts[1] + "px;' height=120>" +
        "<img src='img/happy2.png' style='position:absolute; left:" + sad_lefts[2] + "px;' height=120>" +
      "</div></center>"

    var move_on = "<center><p><i>Click next or press the right-arrow key to move on.</i></p></center>"

    var welcome_block = "<center><p>Welcome to the experiment!</p></center>" + move_on

    var get_subj_data = {
      type: "survey-text",
      questions: ["SubjID:", "Date of birth (mm/dd/yyyy):", "Occupation:", "Highest degree:"]
    }

    var instructions1 = "<center><p>In the following game, you will be taking care of three aliens. " +
      "The aliens live on a strange planet and your goal is to help them grow as fast as possible.</p>" +
      "<p>Each alien needs different things to thrive. " +
      "One alien might need to chew on a shiny rock in order grow, " +
      "whereas another might need to catch cosmic rays with its red umbrella.</p>" +
      "<p>Over time, you will learn what each alien needs in order to grow.</p></center>" +
      aliens +
      move_on

    var instructions2 = "<center><p>The aliensâ€™ planet goes through different seasons, " +
      "and aliens will need different things depending on these seasons.</p>" +
      "<p>For example, in order to grow, one alien might need to chew on a shiny rock in the hot season, " +
      "but it might need to sleep in a bed during the rainy season.</p>" +
      "There are three seasons on the aliens' planet: <i>hot, cold, and rainy</i>:" +
      "<img src='img/hot.png' style='border: 10px solid transparent;' height=" + alien_height + ">" +
      "<img src='img/cold.png' style='border: 10px solid transparent;' hspace='40' height=" + alien_height + ">" +
      "<img src='img/rainy.png' style='border: 10px solid transparent;' hspace='40' height=" + alien_height + "></center>" +
      move_on

    var instructions3 = "<center><p>Let's practice the game with these three aliens:</p>" +
      aliens +
      "<p>Try to make each one of them grow as much as you can, by learning what each one needs!</p></center>" +
      move_on

    var instructions4 = "<center><p>Whenever an alien needs something, it will call you, just like the green alien below:</p>" +
      sad_alien +
      "<div style='position:relative; top=50px'" +
        "<p>When an alien is unhappy like this green alien, you can offer it one of several things to cheer it up and help it grow.</p>" +
        "<p>How about a nap in the green bed? In the game, you'll be able to click on an item to offer it to the unhappy alien.</p>" +
        "<p>Let's pretend you offered the alien a nap in the green bed - click Next to see what happens.</p>" +
      "</div>" +
      response_buttons + "</center>"

    var instructions5 = "<center><p> The green alien liked the nap a lot! It is all happy now and it grew by 5 centimeters! </p>" +
      happy_alien +
      response_buttons + "</center>"

    var instructions6 = "<center><p> When you are ready, you can press Next for a practice round of the game.</p>" +
      "<p>Press Previous if you'd like to review the instructions before you start.</p>" +
      aliens +
      "<p>Try to learn which item each alien likes to help them grow!</p></center>"

    var instructions = {
      type: 'instructions',
      pages: [
          welcome_block,
          instructions1,
          instructions2,
          instructions3,
          instructions4,
          instructions5,
          instructions6
      ],
      show_clickable_nav: true,
      timing_post_trial: 200
    }

    var training_block = {
      type: "categorize-alienzzz2",
      season: "training",
      aliens: [dred_alien, lblue_alien, dgreen_alien],
      feedback_amounts: training_rewards,
      data: {block: "training"},
      randomize_order: true,
      timing_feedback_duration: 1500,
      timing_response: 15000,
      timeout_message: "<p style='text-align:center; font-size:40px; z=10'>" +
                       "Please respond faster next time! </p>",
      timeline: TS_train
    }

    var instructions7 =
      "<center><p> Great job! You helped these three aliens grow a lot! </p>" +
      happy_aliens +
      "<p> When you're ready, press Next to move on to the real game. </p>" +
      "<p> This time, you'll be on the aliens' planet, so the seasons will change! " +
      "Keep in mind that the aliens' preferences change with the seasons! </p></center>"

    var instructions_post = {
      type: 'instructions',
      pages: [instructions7],
      show_clickable_nav: true,
      timing_post_trial: 200
    }

    links = [
      [0, 2, 1],  // everything except [0,1,2] and [2,1,0]
      // [1, 0, 2],  // only need 3
      [1, 2, 0],
      [2, 0, 1]
    ]

    link = links[Math.floor(Math.random() * links.length)]  // TD! Draw according to SubjID or so

    season_rewards = [
      season_rewards_ordered[link[0]],
      season_rewards_ordered[link[1]],
      season_rewards_ordered[link[2]]
    ]

    var hot_season = {
      season: "hot",
      feedback_amounts: season_rewards[0],
      randomize_order: true,
      timeline: TSs[TS_rand[0]]
    }
    var cold_season = {
      season: "cold",
      feedback_amounts: season_rewards[1],
      randomize_order: true,
      timeline: TSs[TS_rand[1]]
    }
    var rainy_season = {
      season: "rainy",
      feedback_amounts: season_rewards[2],
      randomize_order: true,
      timeline: TSs[TS_rand[2]]
    }

    start_new_season_page =
        "style='position:fixed; top:0px; left:0px; bottom:0px; right:0px; z=-10' " +
        "height='100%' width='100%'>" +
      "<p style='position:relative; border: 250px solid transparent; z=10; font-size:60px'><i>New season!</i></p>"

    var start_hot_season = {
      type: "start_new_season",
      show_clickable_nav: true,
      pages: [
        "<img src=img/hot.png " +
          start_new_season_page
      ]
    }

    var start_rainy_season = {
      type: "start_new_season",
      show_clickable_nav: true,
      pages: [
        "<img src=img/rainy.png " +
          start_new_season_page
      ]
    }

    var start_cold_season = {
      type: "start_new_season",
      show_clickable_nav: true,
      pages: [
        "<img src=img/cold.png " +
          start_new_season_page
      ]
    }

    first_rep_chunks = [
      [start_hot_season, hot_season, hot_season, hot_season],
      [start_cold_season, cold_season, cold_season, cold_season],
      [start_rainy_season, rainy_season, rainy_season, rainy_season]
    ]

    second_rep_chunks = [
      [start_hot_season, hot_season, hot_season],
      [start_cold_season, cold_season, cold_season],
      [start_rainy_season, rainy_season, rainy_season]
    ]

    third_rep_chunks = [
      [start_hot_season, hot_season],
      [start_cold_season, cold_season],
      [start_rainy_season, rainy_season]
    ]

    season_orders = [
      [[0, 1, 2], [1, 2, 0], [2, 0, 1]],
      [[1, 2, 0], [2, 0, 1], [0, 1, 2]],
      [[2, 0, 1], [0, 1, 2], [1, 2, 0]]
    ]

    season_order = season_orders[Math.floor(Math.random() * season_orders.length)];  // TD! draw for each subject!

    seasons_in_order = [].concat(
      first_rep_chunks[season_order[0][0]], first_rep_chunks[season_order[0][1]], first_rep_chunks[season_order[0][2]],
      second_rep_chunks[season_order[1][0]], second_rep_chunks[season_order[1][1]], second_rep_chunks[season_order[1][2]],
      third_rep_chunks[season_order[2][0]], third_rep_chunks[season_order[2][1]], third_rep_chunks[season_order[2][2]]
    )

    var all_seasons = {
      type: "categorize-alienzzz2",
      aliens: shuffle([dblue_alien, lgreen_alien, purple_alien]),
      timing_response: 10000,
      timing_feedback_duration: 750,
      timeout_message: "<p style='text-align:center; font-size:40px; z=10'>" +
                       "Please respond faster next time! </p>",
      timeline: seasons_in_order
    }

    var goodbye = {
      type: 'instructions',
      pages: ["<center><p>The game is now over, you did a great job!</p>" +
        "<p>Thank you for participating in the experiment!</p>" +
        "<p>Click Next to finish and download the data!</p></center>"],
      show_clickable_nav: true
    }

    /* create experiment timeline array */
    var timeline = [];
    // timeline.push(get_subj_data);
    // timeline.push(instructions);
    timeline.push(training_block, training_block, training_block);
    timeline.push(instructions_post);
    timeline.push(all_seasons);
    timeline.push(goodbye);

    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      // fullscreen: true,
      // show_progress_bar: true,  // doesn't work when I have a background..
      on_finish: function() {
        jsPsych.data.localSave('test.csv', 'csv')
      }
    });

  </script>
</html>
